name: accept-pull-request

on:
  issue_comment:
    types:
      - created

# Permissions restrictives
permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency: accept-pull-request-${{ github.event.issue.number }}

jobs:
  accept-pull-request:
    if: ${{ github.event.issue.pull_request && (github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' || github.event.comment.body == '/rebase') }}
    env:
      GITHUB_CONTEXT: ${{ toJson(github) }}
      GITHUB_TOKEN: ${{ secrets.HURL_BOT_TOKEN }}
      OWNER: ${{ github.repository_owner }}
      REPO: ${{ github.event.repository.name }}
      PR_NUMBER: ${{ github.event.issue.number }}
      COMMENT_USER_LOGIN: ${{ github.event.comment.user.login }}
      PR_COMMENT: ${{ github.event.comment.body }}
    outputs:
      base_ref: ${{ steps.init-all-internal-env-vars.outputs.base_ref }}
      new_version_master_snapshot_version:  ${{ steps.check-github-release.outputs.new_version_master_snapshot_version }}
      is_a_github_release_pr: ${{ steps.check-github-release.outputs.is_a_github_release_pr }}
    name: accept-pull-request
    runs-on: ubuntu-latest
    steps:

      - name: Check user permission
        run: |
          # √âchapper les variables utilisateur pour √©viter l'injection de commandes
          comment_user_login="${{ github.event.comment.user.login }}"
          # Validation du format du nom d'utilisateur
          if [[ ! "$comment_user_login" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo "Invalid username format"
            exit 1
          fi
          
          comment_user_permission=$(gh api "repos/${OWNER}/${REPO}/collaborators/${comment_user_login}/permission" -q .permission)
          if [ "${comment_user_permission}" = "admin" ] ; then
            echo "  - ‚úÖ You have the ${comment_user_permission} permission then you are allowed to merge pull request n¬∞${PR_NUMBER}"
          else
            comment="‚ùå Sorry \`${comment_user_login}\`, you are not allowed to merge this pull request because you do not have admin permission (actual permission=${comment_user_permission})."
            echo "  - ${comment}"
            # Utiliser printf pour √©viter l'injection dans le commentaire
            printf -v safe_comment "%s" "${comment}"
            gh pr comment "${PR_NUMBER}" --body "${safe_comment}"
            exit 1
          fi

      - name: Init all internal env vars
        id: init-all-internal-env-vars
        env:
             # S√©curiser la variable title
             TITLE: ${{ github.event.issue.title }}
        run: |
          pr_detail_file="pr_detail.json"
          gh api "repos/${OWNER}/${REPO}/pulls/${PR_NUMBER}" > "${pr_detail_file}"
          jq . "${pr_detail_file}"
          
          # √âchapper et valider le titre
          printf "github.event.issue.title: %s\n" "${TITLE}"
          
          HEAD_REPO_FULL_NAME=$(jq -rc .head.repo.full_name "${pr_detail_file}")
          BASE_REPO_FULL_NAME=$(jq -rc .base.repo.full_name "${pr_detail_file}")
          
          # Validation des noms de repo
          if [[ ! "$HEAD_REPO_FULL_NAME" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid HEAD_REPO_FULL_NAME format"
            exit 1
          fi
          if [[ ! "$BASE_REPO_FULL_NAME" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$ ]]; then
            echo "Invalid BASE_REPO_FULL_NAME format"
            exit 1
          fi
          
          if [ "${HEAD_REPO_FULL_NAME}" = "${BASE_REPO_FULL_NAME}" ] ; then
            HEAD_TYPE=origin
          else
            HEAD_TYPE=fork
          fi
          
          echo "HEAD_REPO_FULL_NAME=${HEAD_REPO_FULL_NAME}" | tee -a "${GITHUB_ENV}"
          echo "BASE_REPO_FULL_NAME=${BASE_REPO_FULL_NAME}" | tee -a "${GITHUB_ENV}"
          echo "HEAD_TYPE=${HEAD_TYPE}" | tee -a "${GITHUB_ENV}"
          
          # S√©curiser les r√©f√©rences de branches
          head_ref=$(jq -rc .head.ref "${pr_detail_file}")
          base_ref=$(jq -rc .base.ref "${pr_detail_file}")
          
          # Validation des noms de branches
          if [[ ! "$head_ref" =~ ^[a-zA-Z0-9_./-]+$ ]]; then
            echo "Invalid HEAD_REF format"
            exit 1
          fi
          if [[ ! "$base_ref" =~ ^[a-zA-Z0-9_.//-]+$ ]]; then
            echo "Invalid BASE_REF format"
            exit 1
          fi
          
          echo "HEAD_REF=${head_ref}" | tee -a "${GITHUB_ENV}"
          echo "BASE_REF=${base_ref}" | tee -a "${GITHUB_ENV}"
          echo "PR_STATE=$(jq -rc .state "${pr_detail_file}")" | tee -a "${GITHUB_ENV}"
          echo "PR_DRAFT=$(jq -rc .draft "${pr_detail_file}")" | tee -a "${GITHUB_ENV}"
          echo "PR_MERGEABLE=$(jq -rc .mergeable "${pr_detail_file}")" | tee -a "${GITHUB_ENV}"
          echo "REMAINING_COMMITS_FILE=remaining_commits.txt" | tee -a "${GITHUB_ENV}"
          echo "NEW_COMMITS_FILE=new_commits.txt" | tee -a "${GITHUB_ENV}"
          echo "base_ref=${base_ref}" | tee -a "${GITHUB_OUTPUT}"

      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          persist-credentials: true
          ref: ${{ env.BASE_REF }}
          token: ${{ secrets.HURL_BOT_TOKEN }}
          fetch-depth: 0

      - name: Notify user
        run: |
          # Utiliser une approche plus s√©curis√©e pour d√©terminer l'ordre
          case "${{ github.event.comment.body }}" in
            "/accept")
              order="/accept"
              ;;
            "/accept --force")
              order="/accept --force"
              ;;
            "/rebase")
              order="/rebase"
              ;;
            *)
              echo "Invalid command"
              exit 1
              ;;
          esac
          
          comment="üïó [${order}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}) is running, please wait for completion."
          gh pr comment "${PR_NUMBER}" --body "${comment}"
          echo "ORDER=${order}" | tee -a "${GITHUB_ENV}"

      - name: Init git bot context
        uses: crazy-max/ghaction-import-gpg@v6.3.0
        with:
          gpg_private_key: ${{ secrets.HURL_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.HURL_BOT_GPG_PRIVATE_KEY_PASSPHRASE }}
          git_committer_name: ${{ secrets.HURL_BOT_USER }}
          git_committer_email: ${{ secrets.HURL_BOT_EMAIL }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Add fork source branch
        if: env.HEAD_TYPE == 'fork'
        run: |
          # S√©curiser l'URL du remote
          remote_url="https://${{ secrets.HURL_BOT_USER }}:${{ secrets.HURL_BOT_TOKEN }}@github.com/${HEAD_REPO_FULL_NAME}"
          git remote add fork "${remote_url}"
          git remote --verbose
          git fetch --all
          git remote -v
          git fetch fork
          git branch -va

      - name: Check if PR source branch is not master
        if: env.HEAD_REF == 'master'
        run: |
          comment="‚ùå Can not ${ORDER} this pull request because your working branch is master, please create a new branch as requested in [CONTRIBUTING.md](https://github.com/Orange-OpenSource/hurl/blob/master/CONTRIBUTING.md)."
          echo "  - ${comment}"
          gh pr comment "${PR_NUMBER}" --body "${comment}"
          exit 1

      - name: Check if pull request state is open
        run: |
          if [ "${PR_STATE}" = "open" ] ; then
            echo "  - ‚úÖ Pull request is ${PR_STATE}."
          else
            comment="‚ùå Can not ${ORDER} this pull request because it is not open (actual state=${PR_STATE})."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi

      - name: Check if pull request is ready
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          if [ "${PR_DRAFT}" = "false" ] ; then
            echo "  - ‚úÖ Pull request draft state is ${PR_DRAFT}."
          else
            comment="‚ùå Can not ${ORDER} this pull request because it is still in draft."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi

      - name: Check if pull request is mergeable
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          if [ "${PR_MERGEABLE}" = "true" ] ; then
            echo "  - ‚úÖ Pull request mergeable state is ${PR_MERGEABLE}."
          else
            comment="‚ùå Pull request is not mergeable, please check unresolved discussions and pull request messages."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi

      - name: Check GitHub release
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        id: check-github-release
        run: |
          if [ $(echo "${HEAD_REF}" | grep -Ec '^release/') -eq 0 ] ; then
            echo "  - ‚úÖ Pull request is not about a pending GitHub release."
          else
            echo "is_a_github_release_pr=true" | tee -a "${GITHUB_OUTPUT}"
            tag_version="$(echo "${HEAD_REF}" | cut --delimiter '/' --field 2)"
            
            # Validation du tag version
            if [[ ! "$tag_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Invalid tag version format"
              exit 1
            fi
            
            major=$(echo "${tag_version}" | cut --delimiter "." --field 1)
            minor=$(echo "${tag_version}" | cut --delimiter "." --field 2)
            new_minor="$((minor + 1))"
            echo "major=${major}, minor=${minor}, new_minor=${new_minor}"
            new_version_master_snapshot_version="${major}.${new_minor}.0-SNAPSHOT"
            echo "new_version_master_snapshot_version=${new_version_master_snapshot_version}" | tee -a "${GITHUB_OUTPUT}"
            
            gh_result=$(gh api "repos/${OWNER}/${REPO}/releases/tags/${tag_version}" | tr ":" "=" | tr -d '"' | tr -d " ")
            echo "gh_result=${gh_result}"
            if [ $(echo "${gh_result}" | grep -Ec "message=NotFound|prerelease=true") -eq 0 ] ; then
              comment="‚úÖ GitHub release ${tag_version} is published."
              echo "  - ${comment}"
            else
              comment="üëÅ‚Äçüó® GitHub release ${tag_version} is still in draft/prerelease. Please don't forget to publish it after merging this release PR."
              echo "  - ${comment}"
              gh pr comment "${PR_NUMBER}" --body "${comment}"
            fi
          fi

      - name: Check if source branch is rebased from target branch
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' || github.event.comment.body == '/rebase' }}
        run: |
          git log --oneline --cherry "${HEAD_TYPE}/${HEAD_REF}...origin/${BASE_REF}" > "${REMAINING_COMMITS_FILE}" && exit_code=0 || exit_code=1
          if [ ${exit_code} -eq 1 ] ; then
            comment="‚ùå Rebase check fails. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi
          diff_count=$(grep -c ^+ "${REMAINING_COMMITS_FILE}" || true)
          if [ ${diff_count} -eq 0 ] ; then
            comment="üëå No needs to auto rebase, \`${HEAD_REPO_FULL_NAME}/${HEAD_REF}\` is already rebased from \`${BASE_REPO_FULL_NAME}/${BASE_REF}\`."
            echo "${comment}" 
            if [ "${ORDER}" == "/rebase" ] ; then
                gh pr comment "${PR_NUMBER}" --body "${comment}"
            fi
          else
            git fetch --all
            git switch "${HEAD_REF}"
            git pull
            git rebase "origin/${BASE_REF}" && exit_code=0 || exit_code=1
            git log --oneline -n 20
            if [ ${exit_code} -eq 1 ] ; then
              comment="‚ùå Auto rebase from \`${BASE_REPO_FULL_NAME}/${BASE_REF}\` fails due to conflicts. Sorry but you have to manage this manually. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
              echo "  - ${comment}"
              gh pr comment "${PR_NUMBER}" --body "${comment}"
              exit 1
            fi
            if [ "${HEAD_TYPE}" == "fork" ] ; then
              git push fork "${HEAD_REF}" --force && exit_code=0 || exit_code=1
            else
              git push --force && exit_code=0 || exit_code=1
            fi
            if [ ${exit_code} -eq 0 ] ; then
              comment="üî® Auto rebase from \`${BASE_REPO_FULL_NAME}/${BASE_REF}\` succeeds, \`${HEAD_REPO_FULL_NAME}/${HEAD_REF}\` now embeds these commits:<br>$(echo ; sed "s/+/  -/g" "${REMAINING_COMMITS_FILE}")"
              echo "  - ${comment}"
              gh pr comment "${PR_NUMBER}" --body "${comment}"
              if [ "${ORDER}" == "/accept" ] || [ "${ORDER}" == "/accept --force" ] ; then
                  comment="üïó [${ORDER}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}) is still running, please wait for completion."
                  gh pr comment "${PR_NUMBER}" --body "${comment}"
                  sleep 15
              fi
            else
              comment="‚ùå Auto rebase from \`${BASE_REPO_FULL_NAME}/${BASE_REF}\` fails on \`git push --force\`. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
              echo "  - ${comment}"
              gh pr comment "${PR_NUMBER}" --body "${comment}"
            fi
            git switch "${BASE_REF}"
          fi

      - name: Check if pull request checks are successful
        if: ${{ github.event.comment.body == '/accept' }}
        run: |
          gh pr checks "${PR_NUMBER}" --watch --interval 30 && exit_code=0 || exit_code=$?
          if [ "${exit_code}" -eq 0 ] ; then
            echo "  - ‚úÖ Pull request checks are successful."
          else
            comment="‚ùå Some checks are still failing, please fix them before trying to merge this pull request."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi

      - name: Check if source branch is rebased from target branch
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          git pull
          git log --oneline --cherry "${HEAD_TYPE}/${HEAD_REF}...origin/${BASE_REF}" > "${REMAINING_COMMITS_FILE}" && exit_code=0 || exit_code=1
          if [ ${exit_code} -eq 1 ] ; then
            comment="‚ùå Rebase check fails. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi
          diff_count=$(grep -c ^+ "${REMAINING_COMMITS_FILE}" || true)
          if [ ${diff_count} -eq 0 ] ; then
            echo "  - ‚úÖ ${HEAD_REPO_FULL_NAME}/${HEAD_REF} is already rebased from ${BASE_REPO_FULL_NAME}/${BASE_REF}."
          else
            comment="‚ùå New commits have been pushed to \`${BASE_REPO_FULL_NAME}/${BASE_REF}\` since you accept this PR. You can rebase it by yourself or simply re-accept this PR to execute an auto rebase.<br>Pending commits:<br>$(echo ; sed "s/+/-/g" "${REMAINING_COMMITS_FILE}")"
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi

      - name: Get new commits list
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          git log --oneline --cherry "origin/${BASE_REF}...${HEAD_TYPE}/${HEAD_REF}" | tee "${NEW_COMMITS_FILE}"

      - name: Merge fast forward head ref to base ref
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          git merge "${HEAD_TYPE}/${HEAD_REF}" --ff-only && exit_code=0 || exit_code=1
          if [ ${exit_code} -eq 0 ] ; then
            echo "  - ‚úÖ Merge fast forward succeeds."
          else
            comment="‚ùå Merge fast forward fails. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi
          git push && exit_code=0 || exit_code=1
          if [ ${exit_code} -eq 0 ] ; then
            echo "  - ‚úÖ Push merge fast forward succeeds."
          else
            comment="‚ùå Push merge fast forward fails. Please refer to ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} logs."
            echo "  - ${comment}"
            gh pr comment "${PR_NUMBER}" --body "${comment}"
            exit 1
          fi
      - name: Final comment
        if: ${{ github.event.comment.body == '/accept' || github.event.comment.body == '/accept --force' }}
        run: |
          if [[ "${PR_COMMENT}" =~ "--force" ]] ; then
            comment="‚úÖ Pull request merged with fast forward by \`${COMMENT_USER_LOGIN}\` without waiting for checks."
          else
            comment="‚úÖ Pull request merged with fast forward by \`${COMMENT_USER_LOGIN}\`."
          fi
          gh pr comment "${PR_NUMBER}" --body "${comment}.<br><br>\# List of commits merged from \`${HEAD_REPO_FULL_NAME}/${HEAD_REF}\` branch into \`${BASE_REPO_FULL_NAME}/${BASE_REF}\` branch:<br>$(echo ; sed 's/+/-/g' "${NEW_COMMITS_FILE}")"
