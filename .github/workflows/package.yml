name: package

on:
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      branch:
        description: "ref branch for this workflow"
        default: "master"
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

permissions: {}

jobs:
  package-generic-linux-x64:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5.0.0
      with:
        persist-credentials: false
        ref: ${{ inputs.branch }}
    - name: Install prerequisites
      run: bin/install_prerequisites_ubuntu.sh
    - name: Install Python 3.11
      uses: actions/setup-python@v6.0.0
      with:
        python-version: '3.11'
    - name: Activate python3 venv
      run: |
        bin/activate_python3_venv.sh
        export PATH="/tmp/hurl-python3-venv/bin:$PATH"
        echo "PATH=$PATH" >> $GITHUB_ENV
        which python3
        python3 --version
        pip --version
    - name : Environment
      run: bin/environment.sh
    - name: Install rust
      run: bin/install_rust.sh
    - name: Build
      run: |
        bin/release/release.sh
        echo "PATH=:${PWD}/target/release:$PATH" >> "${GITHUB_ENV}"
    - name: Get version
      run: |
        VERSION=$(bin/release/get_version.sh)
        echo "VERSION=${VERSION}" | tee -a "${GITHUB_ENV}"
    - name: Create generic linux package
      run: |
        bin/release/man.sh
        bin/release/create_tarball.sh
    - name: Archive production artifacts
      uses: actions/upload-artifact@v4.6.2
      with:
        name: release-generic-linux-x64-artifacts
        path: target/upload/*
  test-generic-linux-on-docker-archlinux-x64:
    needs: package-generic-linux-x64
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v5.0.0
      with:
        persist-credentials: false
        ref: ${{ inputs.branch }}
    - name: Retrieve release-generic-linux-x64-artifacts
      uses: actions/download-artifact@v5.0.0
      with:
        name: release-generic-linux-x64-artifacts
        path: target/upload
    - name: Install package and tests integ
      uses: addnab/docker-run-action@v3
      with:
        image: archlinux
        options: --volume ${{ github.workspace }}:/work --workdir /work --privileged
# Revert to libxml 2.13.8 that has a soname libxml2.so.2 required by our Ubuntu Hurl build (using `libxml2-legacy` package).
# Starting from libxml 2.14, <https://gitlab.gnome.org/GNOME/libxml2/-/releases/v2.14.0>:
#
# > Binary compatibility is restricted to versions 2.14 or newer. On ELF systems, the soname was bumped from
# > libxml2.so.2 to libxml2.so.16.
#
# We downgrade when testing the Hurl generic package, not when we're building the Hurl package on Arch Linux as the soname
# problem arise only with the generic package.
        run: |
          set -e
          echo "::group::Install system prerequisites"
            bin/install_prerequisites_archlinux.sh
          echo "::endgroup::"
          echo "::group::Downgrade libxml2"
          pacman --sync --noconfirm libxml2-legacy
          echo "::endgroup::"
          echo "::group::Activate python3 venv"
            bin/activate_python3_venv.sh
            export PATH=/tmp/hurl-python3-venv/bin:$PATH
            which python3
            python3 --version
            pip --version
          echo "::endgroup::"
          echo "::group::Environment"
            bin/environment.sh
          echo "::endgroup::"
          echo "::group::Install generic linux package"
            bin/release/install_generic_linux_package.sh
          export PATH="/tmp/hurl-generic-linux/bin:$PATH"
          echo "::endgroup::"
          echo "::group::Install tests prerequisites"
            bin/test/test_prerequisites.sh
          echo "::endgroup::"
          echo "::group::Tests"
            bin/test/test_integ.sh
          echo "::endgroup::"
    - name: Archive production artifacts
      uses: actions/upload-artifact@v4.6.2
      if: ${{ always() }}
      with:
        name: test-generic-linux-package-docker-archlinux-x64-artifacts
        path: |
          ./**/*.log

